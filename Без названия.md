14 июля 2025 года Cloudflare внесла изменение в сервисные топологии, которое привело к отказу 1.1.1.1 на периферии [сети](https://otus.pw/x7bc/) и, как следствие, к 62-минутному простою для клиентов, использовавших публичный DNS-резолвер 1.1.1.1, а также к периодической деградации сервиса Gateway DNS.

  

Служба резолвера 1.1.1.1 от Cloudflare была недоступна в Интернете с 21:52 до 22:54 UTC. Было затронуто большинство пользователей 1.1.1.1 по всему миру. Для многих невозможность разрешать имена через резолвер 1.1.1.1 означала фактическую недоступность всех интернет-сервисов. Этот сбой виден на [Cloudflare Radar.](https://radar.cloudflare.com/dns?dateStart=2025-07-14&dateEnd=2025-07-15)

  

Сбой произошёл из-за некорректной конфигурации легаси-систем, которые поддерживают инфраструктуру анонсирования IP-адресов Cloudflare в Интернет.

  

Это был глобальный инцидент. В период сбоя резолвер 1.1.1.1 Cloudflare был недоступен по всему миру.

  

Коренной причиной стала не атака и не BGP-хайджек, а внутренняя ошибка конфигурации. В этой статье речь пойдет о том, что именно произошло, почему это произошло и что было сделано, чтобы такое не повторилось.

  

### Предпосылки

  

Cloudflare [представила](https://blog.cloudflare.com/announcing-1111) публичный DNS-резолвер [1.1.1.1](https://one.one.one.one/) в 2018 году. С момента анонса 1.1.1.1 стал одним из самых популярных IP-адресов DNS-резолвера, и им может бесплатно пользоваться любой желающий.

  

Почти все сервисы Cloudflare доступны в Интернете с использованием метода маршрутизации [anycast](https://www.cloudflare.com/learning/cdn/glossary/anycast-network/) — хорошо известной техники, позволяющей обслуживать трафик популярных сервисов во многих разных точках сети, повышая ёмкость и производительность. Это лучший способ обеспечить глобальное управление нашим трафиком, но он также означает, что проблемы с анонсированием этого адресного пространства могут привести к глобальному сбою.

  

Cloudflare анонсирует эти anycast-маршруты в Интернет, чтобы трафик к этим адресам доставлялся в один из дата-центров Cloudflare; сервис обслуживается из множества локаций. Большинство сервисов Cloudflare предоставляются глобально, как и публичный DNS-резолвер 1.1.1.1, однако часть сервисов сознательно ограничена определёнными регионами.

  

Эти сервисы входят в состав нашего [Data Localization Suite](https://developers.cloudflare.com/data-localization/) (DLS), который позволяет клиентам настраивать Cloudflare различными способами для соответствия требованиям регуляторов в разных странах и регионах. Cloudflare настраивает доступ к IP-адресам сервиса лишь там, где это нужно, чтобы трафик по всему миру обрабатывался корректно. Конкретному сервису соответствует «сервисная топология», то есть трафик этого сервиса должен направляться только в заданный набор локаций.

  

6 июня во время релиза по подготовке сервисной топологии для будущего сервиса DLS была внесена ошибка конфигурации: префиксы, связанные с резолвером 1.1.1.1, по ошибке попали в один набор с префиксами, предназначенными для нового сервиса DLS. Эта ошибка «дремала» в продакшен-сети, поскольку новый сервис DLS ещё не использовался, но именно она подготовила почву для сбоя 14 июля. Поскольку немедленных изменений в продакшен-сети не произошло, влияния на конечных пользователей не было, и, как следствие, никакие алерты не сработали.

  
  

## Влияние

  

Затронутым оказался любой трафик, приходивший в Cloudflare через сервисы резолвера 1.1.1.1 на следующих IP-префиксах. Трафик к адресам в этих префиксах также пострадал.

  

```

1.1.1.0/24

1.0.0.0/24

2606:4700:4700::/48

162.159.36.0/24

162.159.46.0/24

172.64.36.0/24

172.64.37.0/24

172.64.100.0/24

172.64.101.0/24

2606:54c1:13::/48

2a06:98c1:54::/48

```

  

Когда началось воздействие, мы наблюдали немедленное и значительное падение числа запросов по UDP, TCP и [DNS через TLS](https://www.rfc-editor.org/rfc/rfc7858) (DoT). У большинства пользователей в качестве DNS-сервера был настроен 1.1.1.1, 1.0.0.1, 2606:4700:4700::1111 или 2606:4700:4700::1001. Ниже показана скорость поступления запросов для каждого из указанных протоколов и то, как они были затронуты во время инцидента.

  

Стоит отметить, что трафик DoH (DNS через HTTPS) оставался относительно стабильным, поскольку большинство пользователей DoH обращаются к публичному резолверу по доменному имени [cloudflare-dns.com](http://cloudflare-dns.com/), заданному вручную или через браузер, а не по IP-адресу. DoH оставался доступным, и трафик почти не пострадал, так как для cloudflare-dns.com используется другой набор IP-адресов. Часть DNS-трафика по UDP, которая также использовала другие IP-адреса, во многом тоже не пострадала.

  

### Техническое расследование и анализ

  

Подход Cloudflare к управлению сервисными топологиями со временем эволюционировал и сейчас представляет собой комбинацию легаси-системы и стратегической (целевой) системы, которые синхронизируются между собой. Диапазоны IP-адресов Cloudflare в настоящее время привязаны и сконфигурированы в этих системах, которые определяют, где именно (в каких дата-центрах на границе сети) должен анонсироваться тот или иной диапазон. Легаси-подход — жёстко прописывать явные списки локаций дата-центров и прикреплять их к конкретным префиксам — оказался подвержен ошибкам: например, ввод нового дата-центра в эксплуатацию требует, чтобы множество разных списков было обновлено и согласованно синхронизировано.

  

У этой модели есть ещё один существенный изъян: обновления конфигурации не следуют методологии поэтапных развёртываний. Даже несмотря на то, что этот релиз прошёл экспертную проверку несколькими инженерами (peer review), изменение не прошло через серию канареечных развёртываний до попадания во все дата-центры Cloudflare.